<!DOCTYPE html>
<html>
<head>
<title>NRLM Block Geo Attendance</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
body{font-family:Arial;background:#eef2f7;margin:0;text-align:center}
header{background:#2b7cff;color:white;padding:15px;font-size:20px}
.box{background:white;margin:20px auto;padding:20px;border-radius:10px;
box-shadow:0px 0px 10px #ccc;width:95%;max-width:800px}
button{padding:8px 12px;margin:5px;border:none;border-radius:5px;
background:#2b7cff;color:white;cursor:pointer}
button:hover{opacity:0.9}
.logout{background:red}
.hide{display:none}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:13px}
.success{color:green;font-weight:bold}
.error{color:red;font-weight:bold}
input{padding:8px;margin:5px;width:90%}
</style>
</head>

<body>

<header>NRLM Block Geo Attendance System</header>

<!-- LOGIN -->
<div id="loginBox" class="box">
<h3>Login</h3>
<input id="userid" placeholder="User ID">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p id="loginMsg"></p>
</div>

<!-- MAIN PANEL -->
<div id="mainPanel" class="hide">

<div class="box">
<h3>Welcome <span id="uname"></span></h3>

<!-- CADRE -->
<div id="cadrePanel" class="hide">
<button onclick="markIn()">Mark IN</button>
<button onclick="markOut()">Mark OUT</button>
<button onclick="showLeave()">Apply Leave</button>
</div>

<!-- BPM -->
<div id="bpmPanel" class="hide">
<button onclick="loadLeaves('BPM')">Load Leave Requests</button>
<table id="bpmTable"></table>
</div>

<!-- BLOCK -->
<div id="blockPanel" class="hide">
<button onclick="loadLeaves('BLOCK')">Load Leave Requests</button>
<button onclick="loadAttendance()">View Attendance</button>
<table id="blockTable"></table>
<table id="attendanceTable"></table>
</div>

<button class="logout" onclick="logout()">Logout</button>

<p id="actionMsg"></p>
</div>

<!-- LEAVE BOX -->
<div id="leaveBox" class="box hide">
<h3>Apply Leave</h3>
<input type="date" id="from">
<input type="date" id="to">
<input id="reason" placeholder="Reason">
<button onclick="applyLeave()">Submit</button>
<button onclick="hideLeave()">Back</button>
<p id="leaveMsg"></p>
</div>

</div>

<script>

var URL="https://script.google.com/macros/s/AKfycbyV6W_YyMufNGAUk0D7frxhy6DoZcGoLnkoOnuy_y4Q0Wcwd0FnOpA6BjR8qMhB25ngYw/exec";

var userid="";
var role="";

// ===== LOGIN =====
function login(){

$.post(URL,{
action:"login",
userid:$("#userid").val(),
password:$("#password").val()
},function(res){

if(res.status=="ok"){

userid=$("#userid").val();
role=res.role;

$("#uname").text(res.name+" ("+role+")");

$("#loginBox").hide();
$("#mainPanel").show();

applyRole();

}else{
$("#loginMsg").html(res.message).addClass("error");
}

},"json");
}

// ===== ROLE CONTROL =====
function applyRole(){

$("#cadrePanel,#bpmPanel,#blockPanel").hide();

if(role=="CADRE"){
$("#cadrePanel").show();
}
else if(role=="BPM"){
$("#bpmPanel").show();
}
else if(role=="BLOCK"){
$("#blockPanel").show();
}
}

// ===== MARK IN =====
function markIn(){

navigator.geolocation.getCurrentPosition(function(pos){

$.post(URL,{
action:"markIn",
userid:userid,
lat:pos.coords.latitude,
lon:pos.coords.longitude
},function(res){

showAction(res);

},"json");

});
}

// ===== MARK OUT =====
function markOut(){

navigator.geolocation.getCurrentPosition(function(pos){

$.post(URL,{
action:"markOut",
userid:userid,
lat:pos.coords.latitude,
lon:pos.coords.longitude
},function(res){

showAction(res);

},"json");

});
}

// ===== APPLY LEAVE =====
function applyLeave(){

$.post(URL,{
action:"applyLeave",
userid:userid,
from:$("#from").val(),
to:$("#to").val(),
reason:$("#reason").val()
},function(res){

if(res.status=="ok"){
$("#leaveMsg").html(res.message).addClass("success");
}else{
$("#leaveMsg").html(res.message).addClass("error");
}

},"json");
}

// ===== LOAD LEAVES =====
function loadLeaves(r){

$.post(URL,{action:"getLeaves"},function(data){

var html="<tr><th>ID</th><th>User</th><th>From</th><th>To</th><th>Reason</th><th>Status</th><th>Action</th></tr>";

for(var i=1;i<data.length;i++){

if(r=="BPM" && data[i][5]=="Pending_BPM"){

html+="<tr>";
html+="<td>"+data[i][0]+"</td>";
html+="<td>"+data[i][1]+"</td>";
html+="<td>"+data[i][2]+"</td>";
html+="<td>"+data[i][3]+"</td>";
html+="<td>"+data[i][4]+"</td>";
html+="<td>"+data[i][5]+"</td>";
html+="<td><button onclick=\"approve('"+data[i][0]+"')\">Forward</button></td>";
html+="</tr>";
}

if(r=="BLOCK" && data[i][5]=="Pending_BLOCK"){

html+="<tr>";
html+="<td>"+data[i][0]+"</td>";
html+="<td>"+data[i][1]+"</td>";
html+="<td>"+data[i][2]+"</td>";
html+="<td>"+data[i][3]+"</td>";
html+="<td>"+data[i][4]+"</td>";
html+="<td>"+data[i][5]+"</td>";
html+="<td><button onclick=\"approve('"+data[i][0]+"')\">Approve</button></td>";
html+="</tr>";
}

}

if(r=="BPM") $("#bpmTable").html(html);
if(r=="BLOCK") $("#blockTable").html(html);

},"json");
}

// ===== APPROVE =====
function approve(id){

$.post(URL,{
action:"approveLeave",
leaveID:id,
role:role
},function(res){

alert(res.message);
loadLeaves(role);

},"json");
}

// ===== LOAD ATTENDANCE =====
function loadAttendance(){

$.post(URL,{action:"getAttendance"},function(data){

var html="<tr>";
for(var i=0;i<data[0].length;i++)
html+="<th>"+data[0][i]+"</th>";
html+="</tr>";

for(var i=1;i<data.length;i++){
html+="<tr>";
for(var j=0;j<data[i].length;j++)
html+="<td>"+data[i][j]+"</td>";
html+="</tr>";
}

$("#attendanceTable").html(html);

},"json");
}

// ===== UTILITIES =====
function showAction(res){
if(res.status=="ok")
$("#actionMsg").html(res.message).addClass("success");
else
$("#actionMsg").html(res.message).addClass("error");
}

function showLeave(){ $("#leaveBox").show(); }
function hideLeave(){ $("#leaveBox").hide(); }
function logout(){ location.reload(); }

</script>
</body>
</html>
