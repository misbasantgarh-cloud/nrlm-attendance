<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NRLM Geo Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      font-family: Arial;
      margin:0;
      background:#f4f6f9;
    }
    .container{
      max-width:420px;
      margin:40px auto;
      background:white;
      padding:20px;
      border-radius:10px;
      box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }
    h2{
      text-align:center;
      margin-bottom:20px;
    }
    input, select, button{
      width:100%;
      padding:10px;
      margin:6px 0;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:14px;
    }
    button{
      background:#0066cc;
      color:white;
      border:none;
      cursor:pointer;
      font-weight:bold;
    }
    button:hover{
      background:#004c99;
    }
    .hidden{
      display:none;
    }
    .logout{
      background:#d9534f;
    }
    .popup{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:white;
      padding:20px;
      border-radius:10px;
      box-shadow:0 5px 15px rgba(0,0,0,0.3);
      display:none;
      text-align:center;
      z-index:1000;
    }
    .overlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.4);
      display:none;
      z-index:999;
    }
  </style>
</head>
<body>

<div class="container" id="loginDiv">
  <h2>NRLM Attendance Login</h2>
  <input type="text" id="username" placeholder="Enter Username">
  <input type="password" id="password" placeholder="Enter Password">
  <button onclick="login()">Login</button>
</div>

<div class="container hidden" id="cadrePanel">
  <h2>Cadre Panel</h2>
  <p><b>Assigned Location:</b> <span id="locationName"></span></p>

  <button onclick="markAttendance('IN')">Mark IN</button>
  <button onclick="markAttendance('OUT')">Mark OUT</button>

  <select id="leaveType">
    <option value="">Select Leave Type</option>
    <option value="CL">Casual Leave</option>
    <option value="ML">Medical Leave</option>
  </select>
  <button onclick="applyLeave()">Apply Leave</button>

  <button class="logout" onclick="logout()">Logout</button>
</div>

<div class="overlay" id="overlay"></div>
<div class="popup" id="popup"></div>

<script>

const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxIg7qDH5g9blBzZtYR1lw0igl2CgvAK009rR9FBqot0iGc0nZIKhxPYiojm70kLVs/exec";

let currentUser = "";

function showPopup(message){
  document.getElementById("popup").innerHTML = message + "<br><br><button onclick='closePopup()'>OK</button>";
  document.getElementById("overlay").style.display="block";
  document.getElementById("popup").style.display="block";
}

function closePopup(){
  document.getElementById("overlay").style.display="none";
  document.getElementById("popup").style.display="none";
}

function login(){
  let user = document.getElementById("username").value;
  let pass = document.getElementById("password").value;

  if(!user || !pass){
    showPopup("Please enter Username & Password");
    return;
  }

  fetch(`${WEBAPP_URL}?action=login&username=${user}&password=${pass}`)
  .then(res=>res.json())
  .then(data=>{
    if(data.status=="success"){
      currentUser = user;
      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("cadrePanel").classList.remove("hidden");
      document.getElementById("locationName").innerText = data.location;
    }else{
      showPopup(data.message);
    }
  });
}

function markAttendance(type){

  if(!navigator.geolocation){
    showPopup("Geolocation not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(function(pos){

    let lat = pos.coords.latitude;
    let lng = pos.coords.longitude;

    fetch(`${WEBAPP_URL}?action=attendance&username=${currentUser}&type=${type}&lat=${lat}&lng=${lng}`)
    .then(res=>res.json())
    .then(data=>{
      showPopup(data.message);
    });

  }, function(){
    showPopup("Please allow location access");
  });
}

function applyLeave(){

  let leaveType = document.getElementById("leaveType").value;

  if(!leaveType){
    showPopup("Select Leave Type");
    return;
  }

  fetch(`${WEBAPP_URL}?action=leave&username=${currentUser}&leaveType=${leaveType}`)
  .then(res=>res.json())
  .then(data=>{
    showPopup(data.message);
  });
}

function logout(){
  currentUser="";
  document.getElementById("loginDiv").classList.remove("hidden");
  document.getElementById("cadrePanel").classList.add("hidden");
}

</script>
</body>
</html>
