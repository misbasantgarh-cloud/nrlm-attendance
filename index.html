
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BasantgarhAttendance</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
*{box-sizing:border-box}
body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background:linear-gradient(to right,#eef2ff,#f8fafc);
}

/* HEADER */
header{
    background:linear-gradient(135deg,#1e3a8a,#2563eb);
    color:white;
    padding:4px;
    text-align:center;
    font-size:18px;
    font-weight:600;
}

/* CARD */
.card{
    background:white;
    margin:20px auto;
    padding:25px;
    width:95%;
    max-width:1100px;
    border-radius:15px;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
}

h3,h4{margin-top:0;color:#1e3a8a}

/* INPUT */
input{
    padding:12px;
    margin:8px 0;
    width:100%;
    max-width:400px;
    border-radius:8px;
    border:1px solid #cbd5e1;
}
input:focus{
    outline:none;
    border-color:#2563eb;
    box-shadow:0 0 0 2px rgba(37,99,235,0.2);
}

/* BUTTON */
button{
    padding:10px 18px;
    margin:8px 5px 8px 0;
    background:#2563eb;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:500;
    transition:0.3s;
}
button:hover{background:#1e40af;transform:translateY(-1px)}
.logout{background:#dc2626}
.logout:hover{background:#991b1b}

/* SUMMARY */
.summary{
    display:flex;
    flex-wrap:wrap;
    gap:15px;
    margin-bottom:20px;
}
.summary div{
    flex:1;
    min-width:150px;
    padding:15px;
    border-radius:12px;
    background:linear-gradient(135deg,#e0f2fe,#f1f5f9);
    text-align:center;
    font-weight:600;
    color:#1e3a8a;
}

/* TABS */
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px}
.tabs button{background:#e2e8f0;color:#1e293b}
.tabs button.activeTab{background:#2563eb;color:white}

/* TABLE */
.table-container{overflow-x:auto}
table{
    width:100%;
    border-collapse:collapse;
    min-width:600px;
}
th,td{
    border:1px solid #e2e8f0;
    padding:10px;
    text-align:center;
    font-size:14px;
}
th{background:#2563eb;color:white}

/* APPROVE BUTTONS */
.approveBtn{background:#16a34a}
.approveBtn:hover{background:#15803d}
.rejectBtn{background:#dc2626}
.rejectBtn:hover{background:#991b1b}

/* LOADER */
.loader{
    position:fixed;
    top:0;left:0;
    width:100%;
    height:100%;
    background:rgba(255,255,255,0.7);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:9999;
    display:none;
}
.spinner{
    border:6px solid #e5e7eb;
    border-top:6px solid #2563eb;
    border-radius:50%;
    width:50px;
    height:50px;
    animation:spin 1s linear infinite;
}
@keyframes spin{100%{transform:rotate(360deg)}}

/* TOAST */
.toast{
    position:fixed;
    bottom:20px;
    right:20px;
    background:#16a34a;
    color:white;
    padding:12px 20px;
    border-radius:8px;
    display:none;
    z-index:9999;
}
.toast.error{background:#dc2626}

/* GEO STATUS */
.geo-status{
    margin-top:10px;
    font-size:14px;
    color:#16a34a;
}

/* MOBILE */
@media(max-width:768px){
    button{width:100%;margin:8px 0}
    .tabs button{flex:1}
}
.hidden{display:none}

    /* Define the animation */
@keyframes blink {
  0% {
    opacity: 1;
  }
  50% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}

/* Apply the animation to the element */
.blink-me {
  animation: blink 1s linear infinite; /* 1s duration, linear timing, infinite loop */
}

</style>
</head>
<body>

<header>
<i class="fa-solid fa-location-dot"></i> NRLM | BPM Attendance Portal
    </br>

<span style="color:#facc15; font-weight:400; text-shadow:0 0 6px rgba(250,204,21,0.6);">
              ⚠ Mark at Assigned Office.
</span>

</header>

<div class="loader" id="loader">
    <div class="spinner"></div>
    <div style="margin-top:15px;font-size:18px;font-weight:bold;color:#1e3a8a;">
    </div></div>


<div class="toast" id="toast"></div>

<!-- LOGIN -->
<div class="card" id="loginCard">
<h3><i class="fa-solid fa-user"></i> Login</h3>
<input type="text" id="username" placeholder="Username">
<div style="position:relative; max-width:400px;">
    <input type="password" id="password" placeholder="Password" style="padding-right:40px;">
    <i class="fa-solid fa-eye" id="togglePassword"
       onclick="togglePassword()"
       style="position:absolute; right:12px; top:50%; transform:translateY(-50%);
              cursor:pointer; color:#64748b;">
    </i>
</div>
<button onclick="login()"><i class="fa-solid fa-right-to-bracket"></i> Login</button>
<p id="loginMsg" style="color:red;"></p>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="dashboard">
<h3 id="welcome"></h3>
<button class="logout" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>

<div class="summary">
<div><i class="fa-solid fa-calendar-check"></i><br>Total Attendance<br><span id="attCount">0</span></div>
<div><i class="fa-solid fa-plane-departure"></i><br>Total Leave<br><span id="leaveCount">0</span></div>
</div>

<div class="tabs" id="tabs"></div>

<div id="attendanceTab" class="hidden">
<h4><i class="fa-solid fa-location-crosshairs"></i> Mark Attendance</h4>
<button onclick="openCamera()"><i class="fa-solid fa-fingerprint"></i> Mark Attendance</button>

<div id="cameraSection" class="hidden" style="margin-top:15px;">

    <!-- Video Wrapper -->
    <div style="position:relative; width:300px;">

        <video id="video" autoplay playsinline width="300" style="border-radius:10px;"></video>

        <!-- Live Overlay -->
        <div id="liveOverlay" style="
            position:absolute;
            bottom:0;
            left:0;
            width:100%;
            background:rgba(0,0,0,0.65);
            color:white;
            font-size:12px;
            padding:8px;
            box-sizing:border-box;
            border-bottom-left-radius:10px;
            border-bottom-right-radius:10px;
        ">
        </div>

    </div>

    <!-- Button OUTSIDE video wrapper -->
    
<button id="captureBtn" style="margin-top:10px;" onclick="capturePhoto()" disabled>
    <i class="fa-solid fa-camera"></i> Waiting for GPS...
</button>


    <canvas id="canvas" class="hidden"></canvas>

</div>



<div class="geo-status" id="geoStatus"></div>
<p id="attMsg"></p>
</div>

<div id="leaveTab" class="hidden">
<h4><i class="fa-solid fa-file-circle-plus"></i> Apply Leave</h4>
<input type="date" id="fromDate">
<input type="date" id="toDate">
<input type="text" id="reason" placeholder="Reason" required>
<button onclick="applyLeave()"><i class="fa-solid fa-paper-plane"></i> Submit Leave</button>
<p id="leaveMsg"></p>
</div>

<div id="approvalLeaveTab" class="hidden">
<h4><i class="fa-solid fa-user-check"></i> Pending Leave Approvals</h4>
<div class="table-container">
<table id="approvalLeaveTable"></table>
</div>
</div>

<div id="approvalAttendanceTab" class="hidden">
<h4><i class="fa-solid fa-clipboard-check"></i> Pending Attendance Approvals</h4>
<div class="table-container">
<table id="approvalAttendanceTable"></table>
</div>
</div>

<div id="reportTab" class="hidden">
<h4><i class="fa-solid fa-chart-column"></i> Attendance & Leave Reports</h4>

<div id="blockDateFilter" style="margin-bottom:15px; display:none;">
    <label><b>From:</b></label>
    <input type="date" id="reportFromDate">
    <label style="margin-left:10px;"><b>To:</b></label>
    <input type="date" id="reportToDate">
</div>

<div id="reportContent"></div>
</div>


<script>

const API="https://script.google.com/macros/s/AKfycbzwO_TotE5IFWLHHTka-pjkfTu8d2LbGS77Iuy78meGEwPJjB4qmFkoCwebOBaDMRPc_A/exec";
let userRole="",userBlock="",userName="",employeeName="";


/* ---------- LOGIN ---------- */
function login(){
let uname = username.value.trim();
let pass = password.value.trim();

loginMsg.style.color = "red";
loginMsg.innerText = "";

/* Validation */
if(uname === ""){
    loginMsg.innerText = "Username is required";
    username.focus();
    return;
}
if(pass === ""){
    loginMsg.innerText = "Password is required";
    password.focus();
    return;
}
if(uname.length < 3){
    loginMsg.innerText = "Username must be at least 3 characters";
    return;
}
if(pass.length < 4){
    loginMsg.innerText = "Password must be at least 4 characters";
    return;
}

/* API Call */
fetch(API,{
  method:"POST",
  body:JSON.stringify({action:"login",username:uname,password:pass})
}).then(r=>r.json()).then(res=>{
  if(res.status==="success"){
    userRole = res.role;
    userBlock = res.block;
    userName = uname;                  // keep username if needed
    employeeName = res.employeeName;   //  ADD THIS
    showDashboard();
}
 
else {
    loginMsg.innerText=res.message || "Username or Password is Incorrect";
  }
});
}

function logout(){ location.reload(); }

/* ---------- DASHBOARD ---------- */
function showDashboard(){
loginCard.classList.add("hidden");
dashboard.classList.remove("hidden");
welcome.innerText=`Welcome ${employeeName} (${userRole} - ${userBlock})`;
setupTabs();
loadCounts();
if(userRole!=="Cadre"){ loadLeaveApprovals(); loadAttendanceApprovals(); }
loadReports();
}

/* ---------- TABS ---------- */
function setupTabs(){
const tabDiv=document.getElementById("tabs"); tabDiv.innerHTML="";
if(userRole==="Cadre"){
tabDiv.innerHTML=`<button onclick="showTab('attendance')" class="activeTab">Attendance</button>
                  <button onclick="showTab('leave')">Leave</button>
                  <button onclick="showTab('report')">My Reports</button>`;
showTab('attendance');
}
if(userRole==="BPM"){
tabDiv.innerHTML=`<button onclick="showTab('approvalLeave')" class="activeTab">Leave Approvals</button>
                  <button onclick="showTab('approvalAttendance')">Attendance Approvals</button>
                  <button onclick="showTab('report')">Block Reports</button>`;
showTab('approvalLeave');
}
if(userRole==="Block"){
tabDiv.innerHTML=`<button onclick="showTab('approvalLeave')" class="activeTab">Leave Approvals</button>
                  <button onclick="showTab('approvalAttendance')">Attendance Approvals</button>
                  <button onclick="showTab('report')">Full Block Reports</button>`;
showTab('approvalLeave');
}
}
function showTab(tab){
attendanceTab.classList.add("hidden"); leaveTab.classList.add("hidden");
approvalLeaveTab.classList.add("hidden"); approvalAttendanceTab.classList.add("hidden"); reportTab.classList.add("hidden");
Array.from(document.querySelectorAll(".tabs button")).forEach(b=>b.classList.remove("activeTab"));
if(tab==="attendance") {attendanceTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(1)").classList.add("activeTab");}
if(tab==="leave") {leaveTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(2)").classList.add("activeTab");}
if(tab==="approvalLeave") {approvalLeaveTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(1)").classList.add("activeTab");}
if(tab==="approvalAttendance") {approvalAttendanceTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(2)").classList.add("activeTab");}
if(tab==="report") {reportTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(3)").classList.add("activeTab");}
}

/* ---------- ATTENDANCE ---------- */
function markAttendance(){
navigator.geolocation.getCurrentPosition(function(pos){
fetch(API,{
method:"POST",
body:JSON.stringify({action:"markAttendance",name:employeeName,role:userRole,block:userBlock,
                      latitude:pos.coords.latitude,longitude:pos.coords.longitude})
}).then(r=>r.json()).then(res=>{
attMsg.innerText=res.message || "Today Attendance Submitted at Your Office";
loadCounts(); loadReports();
});
});
}

/* ---------- LEAVE ---------- */
function applyLeave(){

let from = fromDate.value;
let to = toDate.value;
let reasonText = reason.value.trim();

leaveMsg.style.color = "red";
leaveMsg.innerText = "";

/* Validation */
if(from === ""){
    leaveMsg.innerText = "Please select From Date";
    return;
}
if(to === ""){
    leaveMsg.innerText = "Please select To Date";
    return;
}
if(reasonText === ""){
    leaveMsg.innerText = "Reason is required";
    return;
}
if(reasonText.length < 5){
    leaveMsg.innerText = "Reason must be at least 5 characters";
    return;
}

let fromD = new Date(from);
let toD = new Date(to);
let today = new Date();
today.setHours(0,0,0,0);

if(fromD > toD){
    leaveMsg.innerText = "From Date cannot be after To Date";
    return;
}

if(fromD < today){
    leaveMsg.innerText = "Leave cannot be applied for past dates";
    return;
}

/* Calculate Leave Days */
let diffTime = toD - fromD;
let days = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

/* API Call */
fetch(API,{
method:"POST",
body:JSON.stringify({
    action:"applyLeave",
    name:employeeName,
    block:userBlock,
    from:from,
    to:to,
    reason:reasonText,
    days:days
})
}).then(r=>r.json()).then(res=>{


leaveMsg.style.color="green";
leaveMsg.innerText=res.message || "Leave Submitted Successfully";

/* Clear Fields After Success */
fromDate.value = "";
toDate.value = "";
reason.value = "";

/* Optional: Move focus back to From Date */
fromDate.focus();

loadCounts();
loadReports();


});
}


/* ---------- LEAVE APPROVALS ---------- */
let leaveApprovalDataFull=[], leaveApprovalPage=1, leaveApprovalPageSize=10;
function loadLeaveApprovals(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"getLeave"})})
  .then(r=>r.json()).then(data=>{
    leaveApprovalDataFull=data.slice(1); leaveApprovalPage=1; renderLeaveApprovalTable();
  });
}
function renderLeaveApprovalTable(){

  // STEP 1: FILTER FIRST
  let filteredData = leaveApprovalDataFull.filter(row => {

    if(userRole === "BPM"){
      return row[7] === "Pending_BPM";

    }

    if(userRole === "Block"){
      return row[7] === "Pending_Block";
    }

    return false;
  });

  // STEP 2: PAGINATE FILTERED DATA
  let totalPages = Math.ceil(filteredData.length / leaveApprovalPageSize);
  if(totalPages === 0) totalPages = 1;

  if(leaveApprovalPage > totalPages){
    leaveApprovalPage = totalPages;
  }

  let start = (leaveApprovalPage - 1) * leaveApprovalPageSize;
  let end = start + leaveApprovalPageSize;
  let pageData = filteredData.slice(start, end);

  // STEP 3: BUILD TABLE
  let html = "<tr><th>Name</th><th>From</th><th>To</th><th>Days</th><th>Reason</th><th>Status</th><th>Action</th></tr>";

  pageData.forEach((row, i) => {

    // Get actual sheet row number correctly
    const originalIndex = leaveApprovalDataFull.indexOf(row);
    const sheetRow = originalIndex + 2;

    if(userRole === "BPM"){
      html += `<tr>
        <td>${row[1]}</td>
        <td>${new Date(row[3]).toLocaleDateString()}</td>
        <td>${new Date(row[4]).toLocaleDateString()}</td>
        <td>${row[5]}</td>
        <td>${row[6]}</td>
        <td>${row[7]}</td>
        <td><button onclick="approveLeave(${sheetRow},'approveLeaveBPM')">Approve</button></td>
      </tr>`;
    }

    if(userRole === "Block"){
      html += `<tr>
        <td>${row[1]}</td>
        <td>${new Date(row[3]).toLocaleDateString()}</td>
        <td>${new Date(row[4]).toLocaleDateString()}</td>
        <td>${row[5]}</td>
        <td>${row[6]}</td>
        <td>${row[7]}</td>
        <td><button onclick="approveLeave(${sheetRow},'approveLeaveBlock')">Final Approve</button></td>
      </tr>`;
    }

  });

  html += `<tr>
    <td colspan="7">
      <button onclick="changeLeaveApprovalPage(-1)">Prev</button>
      Page ${leaveApprovalPage} of ${totalPages}
      <button onclick="changeLeaveApprovalPage(1)">Next</button>
    </td>
  </tr>`;

  approvalLeaveTable.innerHTML = html;
}
function changeLeaveApprovalPage(delta){leaveApprovalPage=Math.max(1,Math.min(Math.ceil(leaveApprovalDataFull.length/leaveApprovalPageSize),leaveApprovalPage+delta)); renderLeaveApprovalTable();}

// Updated Leave Approval with Sheet update
function approveLeave(row, action){
  fetch(API, {method:"POST", body:JSON.stringify({action:action,row:row})})
  .then(r=>r.json())
  .then(res=>{
      if(res.status==="success"){
          loadLeaveApprovals();
          loadReports(); loadCounts();
      } else { alert("Approval failed: "+res.message); }
  });
}

/* ---------- ATTENDANCE APPROVAL ---------- */
let attApprovalDataFull=[], attApprovalPage=1, attApprovalPageSize=10;
function loadAttendanceApprovals(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"getAttendance"})})
  .then(r=>r.json()).then(data=>{attApprovalDataFull=data.slice(1); attApprovalPage=1; renderAttendanceApprovalTable();});
}
function renderAttendanceApprovalTable(){
  let start=(attApprovalPage-1)*attApprovalPageSize;
  let end=start+attApprovalPageSize;
  let pageData=attApprovalDataFull.slice(start,end);
  let html="<tr><th>Name</th><th>Date</th><th>Block</th><th>Status</th><th>Action</th></tr>";
  pageData.forEach((row,i)=>{
    const sheetRow = i + 2 + (attApprovalPage-1)*attApprovalPageSize; // Correct row for Sheet
    if(userRole==="BPM" && row[7]==="Pending_BPM")
      html+=`<tr><td>${row[1]}</td><td>${new Date(row[0]).toLocaleDateString()}</td><td>${row[3]}</td>
      <td>${row[7]}</td><td><button onclick="approveAttendance(${sheetRow},'approveAttendanceBPM')">Approve</button></td></tr>`;
    if(userRole==="Block" && row[7]==="Pending_Block")
      html+=`<tr><td>${row[1]}</td><td>${new Date(row[0]).toLocaleDateString()}</td><td>${row[3]}</td>
      <td>${row[7]}</td><td><button onclick="approveAttendance(${sheetRow},'approveAttendanceBlock')">Final Approve</button></td></tr>`;
  });
  html+=`<tr><td colspan="5"><button onclick="changeAttendanceApprovalPage(-1)">Prev</button>
  Page ${attApprovalPage} of ${Math.ceil(attApprovalDataFull.length/attApprovalPageSize)}
  <button onclick="changeAttendanceApprovalPage(1)">Next</button></td></tr>`;
  approvalAttendanceTable.innerHTML=html;
}
function changeAttendanceApprovalPage(delta){attApprovalPage=Math.max(1,Math.min(Math.ceil(attApprovalDataFull.length/attApprovalPageSize),attApprovalPage+delta)); renderAttendanceApprovalTable();}
function approveAttendance(row, action){
  fetch(API, {method:"POST", body:JSON.stringify({action:action,row:row})})
  .then(r=>r.json())
  .then(res=>{
      if(res.status==="success"){
          loadAttendanceApprovals();
          loadReports(); loadCounts();
      } else { alert("Approval failed: "+res.message); }
  });
}
    /* ---------- END ---------- */
/* ---------- REPORTS ---------- */
let reportDataFull=[], reportPage=1, reportPageSize=10;
let reportLeaveDataFull=[];
function loadReports(){
fetch(API,{method:"POST",body:JSON.stringify({action:"getAttendance"})})
.then(r=>r.json()).then(attData=>{
fetch(API,{method:"POST",body:JSON.stringify({action:"getLeave"})})
.then(r=>r.json()).then(leaveData=>{
  let attMap={};
  attData.slice(1).forEach(r=>{if(userRole==="Cadre"&&r[1]!==employeeName)return;if(userRole==="BPM"&&r[3]!==userBlock)return; attMap[r[1]]=(attMap[r[1]]||0)+1;});
  reportDataFull = Object.entries(attMap).map(([name,count])=>({name,count}));
reportLeaveDataFull = leaveData;   //  STORE LEAVE DATA
reportPage = 1;
renderReportTable(reportLeaveDataFull);

});
});
}
function renderReportTable(leaveData){
let start=(reportPage-1)*reportPageSize;
let end=start+reportPageSize;
let pageData=reportDataFull.slice(start,end);
let html="<h5>Attendance Summary</h5><table><tr><th>Name</th><th>Attendance Count</th></tr>";
pageData.forEach(r=>html+=`<tr><td>${r.name}</td><td>${r.count}</td></tr>`);
html+=`<tr><td colspan="2"><button onclick="changeReportPage(-1)">Prev</button>
Page ${reportPage} of ${Math.ceil(reportDataFull.length/reportPageSize)}
<button onclick="changeReportPage(1)">Next</button></td></tr></table>`;
html+="<h5>Leave Summary</h5><table><tr><th>Name</th><th>Days</th><th>Status</th></tr>";
leaveData.slice(1).forEach(r=>{if(userRole==="Cadre"&&r[1]!==employeeName)return;if(userRole==="BPM"&&r[2]!==userBlock)return; html+=`<tr><td>${r[1]}</td><td>${r[5]}</td><td>${r[7]}</td></tr>`;});
html+="</table>"; reportContent.innerHTML=html;
}
function changeReportPage(delta){
  reportPage = Math.max(1,
    Math.min(Math.ceil(reportDataFull.length/reportPageSize),
    reportPage+delta));
  renderReportTable(reportLeaveDataFull);   //  USE STORED DATA
}


/* ---------- COUNTS ---------- */
function loadCounts(){
fetch(API,{method:"POST",body:JSON.stringify({action:"getAttendance"})}).then(r=>r.json()).then(data=>{
    if(userRole==="Cadre"){
        let count = data.slice(1).filter(d=>d[1]===employeeName).length;
        attCount.innerText=count;
    } else if(userRole==="BPM" || userRole==="Block"){
        attCount.innerText=data.length-1;
    }
});
fetch(API,{method:"POST",body:JSON.stringify({action:"getLeave"})}).then(r=>r.json()).then(data=>{
    if(userRole==="Cadre"){
        let count = data.slice(1).filter(d=>d[1]===userName).length;
        leaveCount.innerText=count;
    } else if(userRole==="BPM" || userRole==="Block"){
        leaveCount.innerText=data.length-1;
    }
});
}


let capturedImage = "";
let liveTimeInterval = null;
let currentLatitude = "Fetching...";
let currentLongitude = "Fetching...";
let currentAccuracy = "";
let cameraStream = null;
let gpsWatcherId = null;

function openCamera() {
    const cameraSection = document.getElementById("cameraSection");
    const video = document.getElementById("video");
    const overlay = document.getElementById("liveOverlay");
    const captureBtn = document.getElementById("captureBtn");

    captureBtn.disabled = true;
    captureBtn.innerHTML = '<i class="fa-solid fa-camera"></i> Waiting for GPS...';

    cameraSection.classList.remove("hidden");

    // Stop previous intervals or GPS watchers
    if (liveTimeInterval) clearInterval(liveTimeInterval);
    if (gpsWatcherId) navigator.geolocation.clearWatch(gpsWatcherId);

    // Start Camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: {ideal:1280}, height:{ideal:720} } })
        .then(stream => {
            video.srcObject = stream;
            cameraStream = stream;
        })
        .catch(() => {
            alert("Camera permission denied or not available.");
            return;
        });

    // Continuous GPS
    overlay.innerHTML = "Improving GPS accuracy...";
    gpsWatcherId = navigator.geolocation.watchPosition(
        function (pos) {
            currentLatitude = pos.coords.latitude.toFixed(6);
            currentLongitude = pos.coords.longitude.toFixed(6);
            currentAccuracy = pos.coords.accuracy.toFixed(1) + " m";

            if (pos.coords.accuracy <= 200) {
                captureBtn.disabled = false;
                captureBtn.innerHTML = '<i class="fa-solid fa-camera"></i> Capture Photo';
            } else {
                captureBtn.disabled = true;
                captureBtn.innerHTML = "Improving GPS... (" + currentAccuracy + ")";
            }
        },
        function () {
            currentLatitude = "Not Available";
            currentLongitude = "Not Available";
            currentAccuracy = "Unknown";

            captureBtn.disabled = true;
            captureBtn.innerHTML = "Location Permission Required";
        },
        { enableHighAccuracy: true, maximumAge: 0 }
    );

    // Live Date & Time Overlay
    liveTimeInterval = setInterval(() => {
        const now = new Date();
        overlay.innerHTML =
            `<b>Employee:</b> ${employeeName}<br>` +
            `<b>Block:</b> ${userBlock}<br>` +
            `<b>Date:</b> ${now.toLocaleDateString()}<br>` +
            `<b>Time:</b> ${now.toLocaleTimeString()}<br>` +
            `<b>Latitude:</b> ${currentLatitude}<br>` +
            `<b>Longitude:</b> ${currentLongitude}<br>` +
            `<b>Accuracy:</b> ${currentAccuracy}`;
    }, 1000);
}

function capturePhoto() {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // Adjust canvas size to video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // Draw video frame
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Overlay: semi-transparent background gradient
    const boxHeight = Math.floor(canvas.height * 0.25);
    const gradient = ctx.createLinearGradient(0, canvas.height - boxHeight, 0, canvas.height);
    gradient.addColorStop(0, "rgba(0,0,0,0.6)");
    gradient.addColorStop(1, "rgba(0,0,0,0.8)");
    ctx.fillStyle = gradient;
    ctx.fillRect(0, canvas.height - boxHeight, canvas.width, boxHeight);

    // Dynamic font size
    const fontSize = Math.max(16, Math.floor(canvas.height / 35));
    ctx.font = `bold ${fontSize}px Arial`;
    ctx.fillStyle = "#ffffff";

    const yStart = canvas.height - boxHeight + fontSize;
    ctx.fillText(`Employee: ${employeeName}`, 20, yStart);
    ctx.fillText(`Block: ${userBlock}`, 20, yStart + fontSize + 5);
    const now = new Date();
    ctx.fillText(`Date: ${now.toLocaleDateString()}`, 20, yStart + 2*(fontSize + 5));
    ctx.fillText(`Time: ${now.toLocaleTimeString()}`, 20, yStart + 3*(fontSize + 5));
    ctx.fillText(`Lat: ${currentLatitude}`, 20, yStart + 4*(fontSize + 5));
    ctx.fillText(`Long: ${currentLongitude}`, 20, yStart + 5*(fontSize + 5));

    // Optional watermark
    ctx.globalAlpha = 0.3;
    ctx.font = `${Math.floor(canvas.height/15)}px Arial`;
    ctx.fillText("Basantgarh Attendance", canvas.width - 300, canvas.height - 20);
    ctx.globalAlpha = 1;

    capturedImage = canvas.toDataURL("image/jpeg", 0.95);

    // Shutter flash effect
    const cameraSection = document.getElementById("cameraSection");
    cameraSection.classList.add("flash");
    setTimeout(() => cameraSection.classList.remove("flash"), 300);

    clearInterval(liveTimeInterval);
    markAttendance();
}


function markAttendance() {
    if (!capturedImage) {
        alert("Please capture photo first");
        return;
    }

    navigator.geolocation.getCurrentPosition(function(pos) {
        fetch(API, {
            method: "POST",
            body: JSON.stringify({
                action: "markAttendance",
                name: employeeName,
                role: userRole,
                block: userBlock,
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
                photo: capturedImage
            })
        })
        .then(r => r.json())
        .then(res => {
            attMsg.innerText = res.message || "Attendance Submitted Successfully";
            capturedImage = "";

            // Smooth fade-out
            const cameraSection = document.getElementById("cameraSection");
            cameraSection.classList.add("fade-out");

            setTimeout(() => {
                if(cameraStream){
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                document.getElementById("video").srcObject = null;
                cameraSection.classList.add("hidden");
                cameraSection.classList.remove("fade-out");
            }, 500);

            loadCounts();
            loadReports();
        });
    });
}




    /* ===== LOADER ===== */
function showLoader(){document.getElementById("loader").style.display="flex";}
function hideLoader(){document.getElementById("loader").style.display="none";}

/* ===== TOAST ===== */
function showToast(msg,type="success"){
let t=document.getElementById("toast");
t.innerText=msg;
t.className="toast "+(type==="error"?"error":"");
t.style.display="block";
setTimeout(()=>{t.style.display="none"},3000);
}

/* ===== GEO STATUS ===== */
navigator.geolocation.getCurrentPosition(
()=>{document.getElementById("geoStatus").innerHTML="<i class='fa-solid fa-circle-check'></i> GPS Ready";},
()=>{document.getElementById("geoStatus").innerHTML="<i class='fa-solid fa-triangle-exclamation'></i> GPS Not Enabled";}
);

/* ===== AUTO LOADER FOR ALL FETCH CALLS ===== */
const originalFetch = window.fetch;
window.fetch = function(){
    showLoader();
    return originalFetch.apply(this, arguments)
        .finally(() => hideLoader());
};



/* ================================
   BLOCK DOWNLOAD REPORT BUTTON
================================ */

function downloadFullBlockReportCSV(){

let csv = "Attendance Summary\n";
csv += "Name,Attendance Count\n";

reportDataFull.forEach(r=>{
    csv += r.name + "," + r.count + "\n";
});

csv += "\nLeave Summary\n";
csv += "Name,Days,Status\n";

fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"getLeave"})
})
.then(r=>r.json())
.then(data=>{
    data.slice(1).forEach(row=>{
        csv += row[1] + "," + row[5] + "," + row[7] + "\n";
    });

    let blob = new Blob([csv], { type: "text/csv" });
    let url = window.URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "Full_Block_Report.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
});
}


/* ================================
   WORKING STYLE PDF
================================ */

async function downloadFullBlockReportPDF(){

const { jsPDF } = window.jspdf;
const doc = new jsPDF("landscape");

const pageWidth = doc.internal.pageSize.getWidth();
const pageHeight = doc.internal.pageSize.getHeight();

/* Date Format */
function formatDate(dateObj){
    let d = ("0" + dateObj.getDate()).slice(-2);
    let m = ("0" + (dateObj.getMonth()+1)).slice(-2);
    let y = dateObj.getFullYear();
    return d + "-" + m + "-" + y;
}

function getMonthYear(dateObj){
    const months = ["January","February","March","April","May","June",
                    "July","August","September","October","November","December"];
    return months[dateObj.getMonth()] + " " + dateObj.getFullYear();
}

const today = formatDate(new Date());

const fromDate = document.getElementById("reportFromDate").value;
const toDate = document.getElementById("reportToDate").value;

if(!fromDate || !toDate){
    alert("Please select From and To dates");
    return;
}

let from = new Date(fromDate);
let to = new Date(toDate);
to.setHours(23,59,59,999);

/* ===== HEADER ===== */

doc.setFillColor(37,99,235);
doc.rect(0,0,pageWidth,20,"F");

doc.setTextColor(255,255,255);
doc.setFontSize(16);
doc.setFont(undefined,"bold");
doc.text("Total CLF's = 4 | Total VO's = 45", pageWidth/2, 12, {align:"center"});

doc.setTextColor(0,0,0);
doc.setFontSize(13);
doc.text("NRLM Attendance & Leave Monitoring System", pageWidth/2, 30, {align:"center"});

doc.setFontSize(12);
doc.text("Block: " + userBlock, pageWidth/2, 38, {align:"center"});

doc.setFontSize(10);
doc.text("Date Generated: " + today, pageWidth - 70, 30);
doc.text("Report Range: " + formatDate(from) + " to " + formatDate(to), 14, 30);

/* ===== FETCH DATA ===== */

const attResponse = await fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"getAttendance"})
});
const attData = await attResponse.json();

const leaveResponse = await fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"getLeave"})
});
const leaveData = await leaveResponse.json();

let attendanceRows = [];
let leaveRows = [];

let totalAttendance = 0;
let totalLeaveDays = 0;

let monthlySummary = {};

/* ===== PROCESS ATTENDANCE ===== */

attData.slice(1).forEach(row=>{

    let fullTimestamp = new Date(row[0]);   // Google Sheet Timestamp
    let rowDate = new Date(row[0]);

    if(rowDate >= from && rowDate <= to){

        let timeString = fullTimestamp.toLocaleTimeString();

        attendanceRows.push([
            row[1], 
            formatDate(rowDate), 
            timeString,
            "Present"
        ]);

        totalAttendance++;

        let key = getMonthYear(rowDate);
        if(!monthlySummary[key]) monthlySummary[key] = {attendance:0, leave:0};
        monthlySummary[key].attendance++;
    }
});

/* ===== PROCESS LEAVE ===== */

leaveData.slice(1).forEach(row=>{
    let leaveDate = new Date(row[3]);
    if(leaveDate >= from && leaveDate <= to){

        leaveRows.push([
            row[1],
            formatDate(leaveDate),
            row[5],
            row[7]
        ]);

        let days = Number(row[5]) || 0;
        totalLeaveDays += days;

        let key = getMonthYear(leaveDate);
        if(!monthlySummary[key]) monthlySummary[key] = {attendance:0, leave:0};
        monthlySummary[key].leave += days;
    }
});

/* ===== ATTENDANCE TABLE ===== */

doc.setFontSize(14);
doc.setFont(undefined,"bold");
doc.text("ATTENDANCE", pageWidth/2, 50, {align:"center"});

doc.autoTable({
    startY: 55,
    head: [["Name", "Date", "Time Stamp", "Status"]],
    body: attendanceRows,
    theme: "grid",
    styles: { fontSize: 9 },
    headStyles: { fillColor: [37,99,235] }
});

doc.setFontSize(11);
doc.text("Total Attendance Entries: " + totalAttendance, 14, doc.lastAutoTable.finalY + 8);

/* ===== LEAVE TABLE ===== */

doc.setFontSize(14);
doc.text("LEAVE", pageWidth/2, doc.lastAutoTable.finalY + 20, {align:"center"});

doc.autoTable({
    startY: doc.lastAutoTable.finalY + 25,
    head: [["Name", "Date", "Days", "Status"]],
    body: leaveRows,
    theme: "grid",
    styles: { fontSize: 9 },
    headStyles: { fillColor: [16,163,74] }
});

doc.setFontSize(11);
doc.text("Total Leave Days: " + totalLeaveDays, 14, doc.lastAutoTable.finalY + 8);

/* ===== MONTHLY SUMMARY ===== */

let summaryRows = [];

Object.keys(monthlySummary).forEach(month=>{
    summaryRows.push([
        month,
        monthlySummary[month].attendance,
        monthlySummary[month].leave
    ]);
});

doc.addPage();

doc.setFontSize(16);
doc.setFont(undefined,"bold");
doc.text("MONTHLY SUMMARY BREAKDOWN", pageWidth/2, 30, {align:"center"});

doc.autoTable({
    startY: 40,
    head: [["Month", "Attendance Count", "Leave Days"]],
    body: summaryRows,
    theme: "grid",
    styles: { fontSize: 10 },
    headStyles: { fillColor: [99,102,241] }
});

/* ===== PAGE NUMBERS ===== */

const totalPages = doc.internal.getNumberOfPages();

for(let i=1;i<=totalPages;i++){
    doc.setPage(i);
    doc.setFontSize(9);
    doc.text(
        "Page " + i + " of " + totalPages,
        pageWidth - 40,
        pageHeight - 10
    );
}

doc.save("Block_Report_" + userBlock + "_" + formatDate(from) + "_to_" + formatDate(to) + ".pdf");
}



/* ================================
   SHOW BUTTON ONLY ONCE FOR BLOCK
================================ */

const originalRenderReportTable = renderReportTable;

renderReportTable = function(leaveData){
    originalRenderReportTable(leaveData);

    if(userRole === "Block"){

        document.getElementById("blockDateFilter").style.display = "block";

        // Prevent duplicate button
        if(!document.getElementById("downloadPdfBtn")){

            const container = document.createElement("div");
            container.style.marginBottom = "15px";
            container.id = "blockDownloadContainer";

            const pdfBtn = document.createElement("button");
            pdfBtn.id = "downloadPdfBtn";
            pdfBtn.innerHTML = "<i class='fa-solid fa-file-pdf'></i> Download PDF";
            pdfBtn.onclick = downloadFullBlockReportPDF;

            container.appendChild(pdfBtn);

            const reportTabDiv = document.getElementById("reportTab");
            reportTabDiv.insertBefore(container, reportTabDiv.children[2]);
        }
    }
};


/* ================================
   PASSWORD EYE FEATURE
================================ */
function togglePassword() {
    const passwordField = document.getElementById("password");
    const icon = document.getElementById("togglePassword");

    if (passwordField.type === "password") {
        passwordField.type = "text";
        icon.classList.remove("fa-eye");
        icon.classList.add("fa-eye-slash");
    } else {
        passwordField.type = "password";
        icon.classList.remove("fa-eye-slash");
        icon.classList.add("fa-eye");
    }
}
    
</script>

<style> 
.footer-notice{
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:#fff3cd;
    color:#92400e;
    padding:10px;
    text-align:center;
    font-weight:400;
    box-shadow:0 -2px 10px rgba(0,0,0,0.08);
    z-index:999;
}

body{
    padding-bottom:60px;
}

/* Smooth fade-out */
#cameraSection {
    transition: opacity 0.5s ease, transform 0.5s ease;
}
.fade-out {
    opacity: 0;
    transform: scale(0.95);
}

/* Shutter flash effect */
#cameraSection.flash {
    animation: flash 0.3s;
}
@keyframes flash {
    0% { background-color: rgba(255,255,255,0.5); }
    100% { background-color: transparent; }
}


</style>

<div class="footer-notice">
⚠ All CLF's and VO's Staff Must Mark Daily.
</div>
</body>
</html>














