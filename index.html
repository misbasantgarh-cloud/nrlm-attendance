<script>

const API_URL = "https://script.google.com/macros/s/AKfycbzvnmxeudfLW0-pwvBOp-gwEqzSozxI5OzWri4k0pQBS39Xh8TGaS52bg4QOtmc1V6k/exec";

let currentUser = {};
let userRole = "";

/* ---------------- POPUP ---------------- */
function showPopup(msg){
  document.getElementById("popupMsg").innerHTML = msg;
  document.getElementById("popup").style.display="block";
}
function closePopup(){
  document.getElementById("popup").style.display="none";
}

/* ---------------- LOGIN ---------------- */
async function login(){
  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        action:"login",
        userId:userId.value.trim(),
        password:password.value.trim()
      })
    });

    const data = await res.json();

    if(data.status=="success"){

      currentUser = data;
      userRole = data.role.toUpperCase();

      loginCard.classList.add("hidden");
      dashboard.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");

      userName.innerText = data.name + " ("+data.role+")";

      if(userRole=="CADRE") cadrePanel.classList.remove("hidden");
      if(userRole=="BPM") bpmPanel.classList.remove("hidden");
      if(userRole=="BLOCK") blockPanel.classList.remove("hidden");

      showPopup("Login Successful");

    }else{
      showPopup(data.message);
    }

  }catch(err){
    showPopup("Network Error. Check Internet or Apps Script Deployment.");
  }
}

/* ---------------- GEO LOCATION CORE ---------------- */
function getStableLocation(callback){

  if(!navigator.geolocation){
    showPopup("Geolocation not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(

    function(position){

      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const accuracy = position.coords.accuracy;

      console.log("Accuracy:", accuracy);

      // Reject weak GPS
      if(accuracy > 50){
        showPopup("⚠ Weak GPS Signal ("+Math.round(accuracy)+"m). Move to open area.");
        return;
      }

      callback(lat,lng);

    },

    function(error){
      showPopup("Location permission denied or unavailable.");
    },

    {
      enableHighAccuracy:true,
      timeout:15000,
      maximumAge:0
    }

  );
}

/* ---------------- MARK IN ---------------- */
function markIn(){

  getStableLocation(async function(lat,lng){

    try{
      const res = await fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          action:"markIn",
          userId:currentUser.userId,
          name:currentUser.name,
          role:currentUser.role,
          cadre:currentUser.cadre,
          locationId:currentUser.locationId,
          lat:lat,
          lng:lng
        })
      });

      const data = await res.json();

      if(data.status=="success"){
        showPopup("✅ Marked IN at "+data.location+"<br>"+data.address);
      }else{
        showPopup(data.message);
      }

    }catch(err){
      showPopup("Network Error while Mark IN");
    }

  });
}

/* ---------------- MARK OUT ---------------- */
function markOut(){

  getStableLocation(async function(lat,lng){

    try{
      const res = await fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          action:"markOut",
          userId:currentUser.userId,
          lat:lat,
          lng:lng
        })
      });

      const data = await res.json();
      showPopup(data.message);

    }catch(err){
      showPopup("Network Error while Mark OUT");
    }

  });
}

/* ---------------- APPLY LEAVE ---------------- */
async function applyLeave(){

  if(!fromDate.value || !reason.value){
    showPopup("Fill All Fields");
    return;
  }

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        action:"applyLeave",
        userId:currentUser.userId,
        name:currentUser.name,
        fromDate:fromDate.value,
        toDate:toDate.value,
        reason:reason.value
      })
    });

    const data = await res.json();
    showPopup(data.message);

  }catch(err){
    showPopup("Network Error while Applying Leave");
  }
}

/* ---------------- LOAD LEAVES ---------------- */
async function loadLeaves(){

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"getLeaves"})
    });

    const data = await res.json();

    let html="<tr><th>User</th><th>From</th><th>Status</th><th>Action</th></tr>";

    data.forEach(l=>{

      if(userRole=="BPM" && l[6]=="Pending BPM"){
        html+=`<tr>
        <td>${l[2]}</td>
        <td>${l[3]}</td>
        <td>${l[6]}</td>
        <td>
        <button onclick="updateLeave('${l[0]}','Approved BPM')">Approve</button>
        <button onclick="updateLeave('${l[0]}','Rejected')">Reject</button>
        </td></tr>`;
      }

      if(userRole=="BLOCK" && l[6]=="Pending Block"){
        html+=`<tr>
        <td>${l[2]}</td>
        <td>${l[3]}</td>
        <td>${l[6]}</td>
        <td>
        <button onclick="updateLeave('${l[0]}','Approved')">Approve</button>
        <button onclick="updateLeave('${l[0]}','Rejected')">Reject</button>
        </td></tr>`;
      }

    });

    leaveTable.innerHTML=html;
    leaveTableBlock.innerHTML=html;

  }catch(err){
    showPopup("Error loading leaves");
  }
}

/* ---------------- UPDATE LEAVE ---------------- */
async function updateLeave(id,status){

  await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"updateLeave",
      leaveId:id,
      status:status
    })
  });

  showPopup("Updated");
  loadLeaves();
}

/* ---------------- MONTHLY REPORT ---------------- */
async function loadMonthlyReport(){

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        action:"getMonthlyReport",
        month:reportMonth.value
      })
    });

    const data = await res.json();

    let html="";
    for(let u in data.report){
      html+=`<p><b>${data.report[u].name}</b> - ${data.report[u].presentDays} Days</p>`;
    }

    reportResult.innerHTML=html;

  }catch(err){
    showPopup("Error generating report");
  }
}

function logout(){
  location.reload();
}

</script>
