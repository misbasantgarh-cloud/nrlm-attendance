<html>
<head>

<title>NRLM Geo Attendance System</title>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>

body{
  font-family: Arial;
  background:#eef2f7;
  text-align:center;
}

.box{
  background:white;
  padding:20px;
  margin:20px auto;
  border-radius:10px;
  box-shadow:0px 0px 10px #aaa;
  width:90%;
  max-width:700px;
}

input,select{
  padding:10px;
  margin:5px;
  width:90%;
}

button{
  padding:10px;
  margin:5px;
  width:95%;
  background:#2b7cff;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

.menu button{
  width:auto;
  margin:5px;
}

table{
  width:100%;
  margin-top:10px;
  border-collapse:collapse;
}

th,td{
  padding:8px;
  border:1px solid #ccc;
}

.hide{
  display:none;
}

.logout{
  background:red;
}

.backBtn{
  background:green;
}

#popup{
  position:fixed;
  top:30%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  padding:20px;
  border-radius:10px;
  box-shadow:0px 0px 15px #000;
  display:none;
  z-index:999;
}

.success{
  color:green;
  font-size:18px;
}

.error{
  color:red;
  font-size:18px;
}

.pagination button{
  width:auto;
  margin:3px;
  background:#444;
}

</style>

</head>

<body>

<h2>NRLM Geo Attendance Portal</h2>

<div id="popup">
  <p id="popMsg"></p>
  <button onclick="$('#popup').hide()">OK</button>
</div>


<div class="box" id="loginBox">

<h3>Login</h3>

<input id="userid" placeholder="User ID">
<input id="password" type="password" placeholder="Password">

<button onclick="login()">Login</button>

</div>


<div id="mainPanel" class="hide">

<h3>Welcome <span id="uname"></span></h3>

<div class="menu">

<button id="menuAttendance" onclick="show('attendanceBox')">Attendance</button>

<button id="menuLeave" onclick="show('leaveBox')">Apply Leave</button>

<button id="menuBPM" onclick="show('bpmPanel')" style="display:none;">BPM Approvals</button>

<button id="menuBlock" onclick="show('blockPanel')" style="display:none;">Block Approvals</button>

<button id="menuReports" onclick="show('reportPanel')" style="display:none;">Reports</button>

<button class="logout" onclick="logout()">Logout</button>

</div>



<div class="box hide" id="attendanceBox">

<h3>Mark Attendance</h3>

<button onclick="markIn()">Mark IN</button>
<button onclick="markOut()">Mark OUT</button>

<button class="backBtn" onclick="backHome()">Back</button>

</div>



<div class="box hide" id="leaveBox">

<h3>Apply Leave</h3>

From:
<input id="from">

To:
<input id="to">

Reason:
<input id="reason">

<button onclick="applyLeave()">Apply</button>

<button class="backBtn" onclick="backHome()">Back</button>

</div>



<div class="box hide" id="bpmPanel">

<h3>BPM – Leave Approvals</h3>

<button onclick="loadLeaves()">Load Leave Requests</button>

<table id="bpmLeaveTable"></table>

<div id="leavePagination" class="pagination"></div>

<button class="backBtn" onclick="backHome()">Back</button>

</div>



<div class="box hide" id="blockPanel">

<h3>Block – Final Approvals</h3>

<button onclick="loadLeaves()">Load All Requests</button>

<table id="blockLeaveTable"></table>

<div id="leavePagination2" class="pagination"></div>

<button class="backBtn" onclick="backHome()">Back</button>

</div>



<div class="box hide" id="reportPanel">

<h3>Attendance Reports</h3>

<button onclick="loadReport()">Load Attendance Report</button>

<table id="reportTable"></table>

<div id="reportPagination" class="pagination"></div>

<button class="backBtn" onclick="backHome()">Back</button>

</div>


</div>



<script>

var URL = "https://script.google.com/macros/s/AKfycbwqfshSwYpInJf-2r6J18gx6eU6wpRCZ0Pk76vUD-3gy_oa8paIZx2C4d9ypK5M0juLxQ/exec";

var userid = "";
var userRole = "";

var pageSize = 10;
var currentPage = 1;
var reportData = [];


function showPopup(msg,type){

$("#popMsg").html(msg);

if(type=="success")
$("#popMsg").attr("class","success");
else
$("#popMsg").attr("class","error");

$("#popup").show();

}



function login(){

var id = $("#userid").val().trim();
var pass = $("#password").val().trim();

if(id == ""){
showPopup("Enter User ID","error");
return;
}

if(pass == ""){
showPopup("Enter Password","error");
return;
}

$.post(URL,{

action:"login",
userid:id,
password:pass

},function(res){

var r = JSON.parse(res);

if(r.status == "ok"){

userid = id;
userRole = r.role;

$("#uname").html(r.name + " ("+ r.role +")");

$("#loginBox").hide();
$("#mainPanel").show();

applyRoleInterface(userRole);

showPopup("Login Successful","success");

}
else{
showPopup("Invalid Login","error");
}

});

}



function applyRoleInterface(role){

role = role.toUpperCase().trim();

$("#menuAttendance").hide();
$("#menuLeave").hide();
$("#menuBPM").hide();
$("#menuBlock").hide();
$("#menuReports").hide();

if(role == "CADRE" || role == "CC" || role == "CDEO" || role == "MOBILIZER"){

    $("#menuAttendance").show();
    $("#menuLeave").show();

}

else if(role == "BPM"){

    $("#menuBPM").show();

}

else if(role == "BLOCK"){

    $("#menuBPM").show();
    $("#menuBlock").show();
    $("#menuReports").show();

}

}



function markIn(){

navigator.geolocation.getCurrentPosition(function(p){

$.post(URL,{

action:"markIn",
userid:userid,
lat:p.coords.latitude,
lon:p.coords.longitude

},function(res){

showPopup(res,"success");

});

});

}



function markOut(){

navigator.geolocation.getCurrentPosition(function(p){

$.post(URL,{

action:"markOut",
userid:userid,
lat:p.coords.latitude,
lon:p.coords.longitude

},function(res){

showPopup(res,"success");

});

});

}



function applyLeave(){

var reason = $("#reason").val();

if(reason.trim()==""){

showPopup("Reason Required","error");
return;

}

$.post(URL,{

action:"applyLeave",
userid:userid,
from:$("#from").val(),
to:$("#to").val(),
reason:reason

},function(res){

showPopup(res,"success");

});

}



// ----------- LEAVE REQUESTS WITH PAGINATION -----------

function loadLeaves(){

$.post(URL,{action:"getLeaves"},function(res){

reportData = JSON.parse(res);

currentPage = 1;

renderLeaveTable();

});

}



function renderLeaveTable(){

var start = (currentPage-1) * pageSize;
var end = start + pageSize;

var d = reportData;

var html = "<tr><th>ID</th><th>User</th><th>From</th><th>To</th><th>Reason</th><th>Status</th></tr>";

for(var i=start+1; i<d.length && i<end+1; i++){

html += "<tr>";
html += "<td>"+d[i][0]+"</td>";
html += "<td>"+d[i][1]+"</td>";
html += "<td>"+d[i][2]+"</td>";
html += "<td>"+d[i][3]+"</td>";
html += "<td>"+d[i][4]+"</td>";
html += "<td>"+d[i][5]+"</td>";
html += "</tr>";

}

$("#bpmLeaveTable").html(html);
$("#blockLeaveTable").html(html);

renderLeavePagination();

}



function renderLeavePagination(){

var total = reportData.length - 1;
var pages = Math.ceil(total / pageSize);

var p = "";

for(var i=1;i<=pages;i++){
p += "<button onclick='gotoLeavePage("+i+")'>"+i+"</button>";
}

$("#leavePagination").html(p);
$("#leavePagination2").html(p);

}



function gotoLeavePage(p){
currentPage = p;
renderLeaveTable();
}



// ----------- ATTENDANCE REPORT PAGINATION -----------

function loadReport(){

$.post(URL,{action:"getReport"},function(res){

reportData = JSON.parse(res);

currentPage = 1;

renderReportTable();

});

}



function renderReportTable(){

var start = (currentPage-1) * pageSize;
var end = start + pageSize;

var d = reportData;

var html="<tr>";

for(var i=0;i<d[0].length;i++)
html+="<th>"+d[0][i]+"</th>";

html+="</tr>";


for(var i=start+1; i<d.length && i<end+1; i++){

html+="<tr>";

for(var j=0;j<d[i].length;j++)
html+="<td>"+d[i][j]+"</td>";

html+="</tr>";

}

$("#reportTable").html(html);

renderReportPagination();

}



function renderReportPagination(){

var total = reportData.length - 1;
var pages = Math.ceil(total / pageSize);

var p = "";

for(var i=1;i<=pages;i++){
p += "<button onclick='gotoReportPage("+i+")'>"+i+"</button>";
}

$("#reportPagination").html(p);

}



function gotoReportPage(p){
currentPage = p;
renderReportTable();
}



function logout(){
location.reload();
}

function show(id){
$(".box").hide();
$("#"+id).show();
}

function backHome(){
$(".box").hide();
}

</script>


</body>
</html>
