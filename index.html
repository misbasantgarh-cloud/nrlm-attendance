<!DOCTYPE html>
<html>
<head>
<title>NRLM Attendance</title>
<style>
body{font-family:Arial;text-align:center;background:#f4f6f9}
button{padding:10px 20px;margin:5px}
.hidden{display:none}
</style>
</head>
<body>

<h2>NRLM Attendance System dddddddd</h2>

<div id="loginBox">
  <input id="mobile" placeholder="Mobile"><br><br>
  <input id="password" type="password" placeholder="Password"><br><br>
  <button onclick="login()">Login</button>
</div>

<div id="dashboard" class="hidden">
  <h3 id="welcome"></h3>

  <div id="cadrePanel" class="hidden">
    <button onclick="markIn()">Mark IN</button>
    <button onclick="markOut()">Mark OUT</button>
    <br><br>
    <input type="date" id="from">
    <input type="date" id="to">
    <input placeholder="Reason" id="reason">
    <button onclick="applyLeave()">Apply Leave</button>
  </div>

  <div id="bpmPanel" class="hidden">
    <br><br>
<input type="month" id="reportMonth">
<button onclick="getReport()">Monthly Report</button>
<div id="reportBox"></div>

    <button onclick="loadLeaves()">View Leaves</button>
    <div id="leaveList"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzggasXxWffwh2OI3zDSJwlYgaKpALqyZijjPMQv4z-q3rEsVxZStN94V0hWfCWRL3HtA/exec";
let currentUser = {};

function login(){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"login",
      mobile:mobile.value,
      password:password.value
    })
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.status==="success"){
      currentUser = data.user;
      loginBox.classList.add("hidden");
      dashboard.classList.remove("hidden");
      welcome.innerText="Welcome "+currentUser.name;

      if(currentUser.role==="CADRE"){
        cadrePanel.classList.remove("hidden");
      }else{
        bpmPanel.classList.remove("hidden");
      }
    }else{
      alert(data.message);
    }
  });
}

function markIn(){
  navigator.geolocation.getCurrentPosition(pos=>{
    sendAttendance("markIn",pos);
  });
}

function markOut(){
  navigator.geolocation.getCurrentPosition(pos=>{
    sendAttendance("markOut",pos);
  });
}

function sendAttendance(type,pos){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:type,
      ...currentUser,
      lat:pos.coords.latitude,
      lng:pos.coords.longitude
    })
  })
  .then(res=>res.json())
  .then(data=>alert(data.message));
}

function applyLeave(){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"applyLeave",
      userId:currentUser.userId,
      name:currentUser.name,
      role:currentUser.role,
      from:from.value,
      to:to.value,
      reason:reason.value
    })
  })
  .then(res=>res.json())
  .then(data=>alert(data.message));
}

function loadLeaves(){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"getLeaves"})
  })
  .then(res=>res.json())
  .then(data=>{
    let html="";
    data.leaves.forEach((row,i)=>{
      if(i===0)return;
      html+=`
        <p>${row[1]} | ${row[6]}
        <button onclick="approve(${i})">Approve</button>
        </p>`;
    });
    leaveList.innerHTML=html;
  });
}

function approve(row){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"updateLeave",
      row:row,
      status:"APPROVED",
      updatedBy:currentUser.name
    })
  })
  .then(res=>res.json())
  .then(()=>alert("Updated"));
}



  function getReport(){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"getMonthlyReport",
      month:reportMonth.value
    })
  })
  .then(res=>res.json())
  .then(data=>{
    let html="";
    for(let id in data.report){
      html+= `<p>${data.report[id].name} - ${data.report[id].presentDays} Days</p>`;
    }
    reportBox.innerHTML=html;
  });
}

</script>

</body>
</html>


