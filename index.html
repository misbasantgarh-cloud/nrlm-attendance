<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NRLM Geo Attendance & MIS</title>
<style>
body{font-family:Segoe UI;background:#eef2ff;margin:0}
header{background:#1e3a8a;color:white;padding:15px;text-align:center;font-size:20px}
.card{background:white;margin:20px auto;padding:20px;width:95%;max-width:1000px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1)}
input,select{padding:8px;margin:5px;width:250px}
button{padding:8px 15px;margin:5px;background:#1e3a8a;color:white;border:none;border-radius:5px;cursor:pointer}
button:hover{opacity:0.9}
.logout{background:#dc2626}
.hidden{display:none}
.tabs button{background:#e5e7eb;color:black}
.activeTab{background:#1e3a8a;color:white}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#1e3a8a;color:white}
.summary{display:flex;justify-content:space-around;margin-bottom:15px}
.summary div{background:#f1f5f9;padding:10px;border-radius:8px;text-align:center}
</style>
<!-- XLSX for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- html2pdf for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<header>NRLM Geo Attendance & MIS Portal</header>

<!-- LOGIN -->
<div class="card" id="loginCard">
<h3>Login</h3>
<input type="text" id="username" placeholder="Username"><br>
<input type="password" id="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
<p id="loginMsg" style="color:red;"></p>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="dashboard">
<h3 id="welcome"></h3>
<button class="logout" onclick="logout()">Logout</button>

<div class="summary">
<div>Total Attendance: <span id="attCount">0</span></div>
<div>Total Leave: <span id="leaveCount">0</span></div>
</div>

<div class="tabs" id="tabs"></div>

<!-- ATTENDANCE -->
<div id="attendanceTab" class="hidden">
<h4>Mark Attendance</h4>
<button onclick="markAttendance()">Mark Attendance</button>
<p id="attMsg"></p>
</div>

<!-- LEAVE -->
<div id="leaveTab" class="hidden">
<h4>Apply Leave</h4>
<input type="date" id="fromDate">
<input type="date" id="toDate"><br>
<input type="text" id="reason" placeholder="Reason"><br>
<button onclick="applyLeave()">Submit Leave</button>
<p id="leaveMsg"></p>
</div>

<!-- LEAVE APPROVAL -->
<div id="approvalLeaveTab" class="hidden">
<h4>Pending Leave Approvals</h4>
<table id="approvalLeaveTable"></table>
</div>

<!-- ATTENDANCE APPROVAL -->
<div id="approvalAttendanceTab" class="hidden">
<h4>Pending Attendance Approvals</h4>
<table id="approvalAttendanceTable"></table>
</div>

<!-- REPORT -->
<div id="reportTab" class="hidden">
<h4>Attendance & Leave Reports</h4>

<!-- Export Buttons for Block -->
<div id="exportButtons" class="hidden" style="margin-bottom:10px;">
  <button onclick="exportExcel()">Download Excel</button>
  <button onclick="exportPDF()">Download PDF</button>
</div>

<div id="reportContent"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbx0_111H5tK69EWh0R3Pqqx1BwkmRuo2RccdAni9kK9aWYGx8KIUPWCE6vQHmQ3sihZHA/exec";
let userRole="",userBlock="",userName="";

/* ---------- LOGIN ---------- */
function login(){
fetch(API,{
  method:"POST",
  body:JSON.stringify({action:"login",username:username.value,password:password.value})
}).then(r=>r.json()).then(res=>{
  if(res.status==="success"){
    userRole=res.role; userBlock=res.block; userName=username.value;
    showDashboard();
  } else { loginMsg.innerText=res.message; }
});
}
function logout(){ location.reload(); }

/* ---------- DASHBOARD ---------- */
function showDashboard(){
loginCard.classList.add("hidden");
dashboard.classList.remove("hidden");
welcome.innerText=`Welcome ${userRole} (${userBlock})`;
setupTabs();
loadCounts();
if(userRole!=="Cadre"){ loadLeaveApprovals(); loadAttendanceApprovals(); }
loadReports();

/* ---------- SHOW EXPORT BUTTONS FOR BLOCK ---------- */
if(userRole==="Block"){
  document.getElementById("exportButtons").classList.remove("hidden");
} else {
  document.getElementById("exportButtons").classList.add("hidden");
}
}

/* ---------- TABS ---------- */
function setupTabs(){
const tabDiv=document.getElementById("tabs"); tabDiv.innerHTML="";
if(userRole==="Cadre"){
tabDiv.innerHTML=`<button onclick="showTab('attendance')" class="activeTab">Attendance</button>
                  <button onclick="showTab('leave')">Leave</button>
                  <button onclick="showTab('report')">My Reports</button>`;
showTab('attendance');
}
if(userRole==="BPM"){
tabDiv.innerHTML=`<button onclick="showTab('approvalLeave')" class="activeTab">Leave Approvals</button>
                  <button onclick="showTab('approvalAttendance')">Attendance Approvals</button>
                  <button onclick="showTab('report')">Block Reports</button>`;
showTab('approvalLeave');
}
if(userRole==="Block"){
tabDiv.innerHTML=`<button onclick="showTab('approvalLeave')" class="activeTab">Leave Approvals</button>
                  <button onclick="showTab('approvalAttendance')">Attendance Approvals</button>
                  <button onclick="showTab('report')">Full Block Reports</button>`;
showTab('approvalLeave');
}
}
function showTab(tab){
attendanceTab.classList.add("hidden"); leaveTab.classList.add("hidden");
approvalLeaveTab.classList.add("hidden"); approvalAttendanceTab.classList.add("hidden"); reportTab.classList.add("hidden");
Array.from(document.querySelectorAll(".tabs button")).forEach(b=>b.classList.remove("activeTab"));
if(tab==="attendance") {attendanceTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(1)").classList.add("activeTab");}
if(tab==="leave") {leaveTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(2)").classList.add("activeTab");}
if(tab==="approvalLeave") {approvalLeaveTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(1)").classList.add("activeTab");}
if(tab==="approvalAttendance") {approvalAttendanceTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(2)").classList.add("activeTab");}
if(tab==="report") {reportTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(3)").classList.add("activeTab");}
}

/* ---------- ATTENDANCE & LEAVE ---------- */
// (All your previous code for markAttendance, applyLeave, approvals remain unchanged)

/* ---------- EXPORT TO EXCEL ---------- */
function exportExcel(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"getAttendance"})})
  .then(r=>r.json()).then(attData=>{
    fetch(API,{method:"POST",body:JSON.stringify({action:"getLeave"})})
    .then(r=>r.json()).then(leaveData=>{
      let wb = XLSX.utils.book_new();

      // Attendance Sheet - filter by Block
      let attSheet = XLSX.utils.json_to_sheet(attData.slice(1).filter(r=>r[3]===userBlock).map(r=>{
        return {Date: r[0], Name:r[1], Role:r[2], Block:r[3], Status:r[7]};
      }));
      XLSX.utils.book_append_sheet(wb, attSheet, "Attendance");

      // Leave Sheet - filter by Block
      let leaveSheet = XLSX.utils.json_to_sheet(leaveData.slice(1).filter(r=>r[2]===userBlock).map(r=>{
        return {Name:r[1], Block:r[2], From:r[3], To:r[4], Days:r[5], Reason:r[6], Status:r[7]};
      }));
      XLSX.utils.book_append_sheet(wb, leaveSheet, "Leave");

      XLSX.writeFile(wb, `NRLM_Report_${userBlock}.xlsx`);
    });
  });
}

/* ---------- EXPORT TO PDF ---------- */
function exportPDF(){
  let content = document.getElementById("reportContent").innerHTML;
  let opt = {
    margin:       10,
    filename:     `NRLM_Report_${userBlock}.pdf`,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2 },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().from(content).set(opt).save();
}

</script>
</body>
</html>
