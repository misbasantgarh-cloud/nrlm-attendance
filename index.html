<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NRLM Geo Attendance & MIS</title>
<style>
body{font-family:Segoe UI;background:#eef2ff;margin:0}
header{background:#1e3a8a;color:white;padding:15px;text-align:center;font-size:20px}
.card{background:white;margin:20px auto;padding:20px;width:95%;max-width:1000px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1)}
input,select{padding:8px;margin:5px;width:250px}
button{padding:8px 15px;margin:5px;background:#1e3a8a;color:white;border:none;border-radius:5px;cursor:pointer}
button:hover{opacity:0.9}
.logout{background:#dc2626}
.hidden{display:none}
.tabs button{background:#e5e7eb;color:black}
.activeTab{background:#1e3a8a;color:white}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#1e3a8a;color:white}
.summary{display:flex;justify-content:space-around;margin-bottom:15px}
.summary div{background:#f1f5f9;padding:10px;border-radius:8px;text-align:center}
</style>
</head>
<body>

<header>NRLM Geo Attendance & MIS Portal</header>

<!-- LOGIN CARD -->
<div class="card" id="loginCard">
<h3>Login</h3>
<input type="text" id="username" placeholder="Username"><br>
<input type="password" id="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
<p id="loginMsg" style="color:red;"></p>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="dashboard">
<h3 id="welcome"></h3>
<button class="logout" onclick="logout()">Logout</button>

<!-- Summary -->
<div class="summary">
<div>Total Attendance: <span id="attCount">0</span></div>
<div>Total Leave: <span id="leaveCount">0</span></div>
</div>

<!-- Tabs -->
<div class="tabs" id="tabs"></div>

<!-- TAB CONTENT -->
<div id="attendanceTab" class="hidden">
<h4>Mark Attendance</h4>
<button onclick="markAttendance()">Mark Attendance</button>
<p id="attMsg"></p>
</div>

<div id="leaveTab" class="hidden">
<h4>Apply Leave</h4>
<input type="date" id="fromDate">
<input type="date" id="toDate"><br>
<input type="text" id="reason" placeholder="Reason"><br>
<button onclick="applyLeave()">Submit Leave</button>
<p id="leaveMsg"></p>
</div>

<div id="approvalLeaveTab" class="hidden">
<h4>Pending Leave Approvals</h4>
<table id="approvalLeaveTable"></table>
</div>

<div id="approvalAttendanceTab" class="hidden">
<h4>Pending Attendance Approvals</h4>
<table id="approvalAttendanceTable"></table>
</div>

<div id="reportTab" class="hidden">
<h4>Attendance & Leave Reports</h4>
<div id="reportContent"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycby1CnSQrXoIva_LKEQ_VrP-0YCmpx_tMTXNOWMUEWOtSDkT6k_fwXUUKpdMfuaG4lnKVA/exec";

let userRole="",userBlock="",userName="";

/* ---------- LOGIN ---------- */
function login(){
fetch(API,{
method:"POST",
body:JSON.stringify({action:"login",username:username.value,password:password.value})
}).then(r=>r.json()).then(res=>{
if(res.status==="success"){
userRole=res.role;
userBlock=res.block;
userName=username.value;
showDashboard();
}else{
loginMsg.innerText=res.message;
}
});
}

function logout(){ location.reload(); }

/* ---------- DASHBOARD ---------- */
function showDashboard(){
loginCard.classList.add("hidden");
dashboard.classList.remove("hidden");
welcome.innerText=`Welcome ${userRole} (${userBlock})`;

setupTabs();
loadCounts();
if(userRole!=="Cadre") { loadLeaveApprovals(); loadAttendanceApprovals(); }
loadReports();
}

/* ---------- TABS ---------- */
function setupTabs(){
const tabDiv=document.getElementById("tabs");
tabDiv.innerHTML="";

if(userRole==="Cadre"){
tabDiv.innerHTML=`<button onclick="showTab('attendance')" class="activeTab">Attendance</button>
                  <button onclick="showTab('leave')">Leave</button>
                  <button onclick="showTab('report')">My Reports</button>`;
showTab('attendance');
}
if(userRole==="BPM"){
tabDiv.innerHTML=`<button onclick="showTab('approvalLeave')" class="activeTab">Leave Approvals</button>
                  <button onclick="showTab('approvalAttendance')">Attendance Approvals</button>
                  <button onclick="showTab('report')">Block Reports</button>`;
showTab('approvalLeave');
}
if(userRole==="Block"){
tabDiv.innerHTML=`<button onclick="showTab('approvalLeave')" class="activeTab">Leave Approvals</button>
                  <button onclick="showTab('approvalAttendance')">Attendance Approvals</button>
                  <button onclick="showTab('report')">Full Block Reports</button>`;
showTab('approvalLeave');
}
}

function showTab(tab){
attendanceTab.classList.add("hidden");
leaveTab.classList.add("hidden");
approvalLeaveTab.classList.add("hidden");
approvalAttendanceTab.classList.add("hidden");
reportTab.classList.add("hidden");

Array.from(document.querySelectorAll(".tabs button")).forEach(b=>b.classList.remove("activeTab"));

if(tab==="attendance") {attendanceTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(1)").classList.add("activeTab");}
if(tab==="leave") {leaveTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(2)").classList.add("activeTab");}
if(tab==="approvalLeave") {approvalLeaveTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(1)").classList.add("activeTab");}
if(tab==="approvalAttendance") {approvalAttendanceTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(2)").classList.add("activeTab");}
if(tab==="report") {reportTab.classList.remove("hidden"); document.querySelector(".tabs button:nth-child(3)").classList.add("activeTab");}
}

/* ---------- ATTENDANCE ---------- */
function markAttendance(){
navigator.geolocation.getCurrentPosition(function(pos){
fetch(API,{
method:"POST",
body:JSON.stringify({action:"markAttendance",name:userName,role:userRole,block:userBlock,
                      latitude:pos.coords.latitude,longitude:pos.coords.longitude})
}).then(r=>r.json()).then(res=>{
attMsg.innerText=res.message || "Attendance Submitted";
loadCounts();
loadReports();
});
});
}

/* ---------- LEAVE ---------- */
function applyLeave(){
fetch(API,{
method:"POST",
body:JSON.stringify({action:"applyLeave",name:userName,block:userBlock,
                      from:fromDate.value,to:toDate.value,reason:reason.value})
}).then(r=>r.json()).then(res=>{
leaveMsg.innerText=res.message || "Leave Submitted";
loadCounts();
loadReports();
});
}

/* ---------- LEAVE APPROVALS WITH PAGINATION ---------- */
let leaveApprovalDataFull = [];
let leaveApprovalPage = 1;
const leaveApprovalPageSize = 10;

function loadLeaveApprovals(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"getLeave"})})
  .then(r=>r.json()).then(data=>{
    leaveApprovalDataFull = data.slice(1);
    leaveApprovalPage = 1;
    renderLeaveApprovalTable();
  });
}

function renderLeaveApprovalTable(){
  let start = (leaveApprovalPage-1)*leaveApprovalPageSize;
  let end = start + leaveApprovalPageSize;
  let pageData = leaveApprovalDataFull.slice(start,end);

  let html="<tr><th>Name</th><th>From</th><th>To</th><th>Days</th><th>Reason</th><th>Status</th><th>Action</th></tr>";
  pageData.forEach((row,i)=>{
    if(userRole==="BPM" && row[7]==="Pending_BPM" && row[2]===userBlock)
      html+=`<tr><td>${row[1]}</td><td>${formatDate(row[3])}</td><td>${formatDate(row[4])}</td>
      <td>${row[5]}</td><td>${row[6]}</td><td>${row[7]}</td>
      <td><button onclick="approveLeave(${i+1+(leaveApprovalPage-1)*leaveApprovalPageSize},'approveLeaveBPM')">Approve</button></td></tr>`;
    if(userRole==="Block" && row[7]==="Pending_Block")
      html+=`<tr><td>${row[1]}</td><td>${formatDate(row[3])}</td><td>${formatDate(row[4])}</td>
      <td>${row[5]}</td><td>${row[6]}</td><td>${row[7]}</td>
      <td><button onclick="approveLeave(${i+1+(leaveApprovalPage-1)*leaveApprovalPageSize},'approveLeaveBlock')">Final Approve</button></td></tr>`;
  });

  html += `<tr><td colspan="7">
    <button onclick="changeLeaveApprovalPage(-1)">Prev</button>
    Page ${leaveApprovalPage} of ${Math.ceil(leaveApprovalDataFull.length/leaveApprovalPageSize)}
    <button onclick="changeLeaveApprovalPage(1)">Next</button>
  </td></tr>`;

  approvalLeaveTable.innerHTML = html;
}

function changeLeaveApprovalPage(delta){
  const totalPages = Math.ceil(leaveApprovalDataFull.length/leaveApprovalPageSize);
  leaveApprovalPage += delta;
  if(leaveApprovalPage<1) leaveApprovalPage=1;
  if(leaveApprovalPage>totalPages) leaveApprovalPage=totalPages;
  renderLeaveApprovalTable();
}

function approveLeave(row,action){
fetch(API,{method:"POST",body:JSON.stringify({action:action,row:row})})
.then(()=>{loadLeaveApprovals(); loadReports();});
}

/* ---------- ATTENDANCE APPROVALS WITH PAGINATION ---------- */
let attApprovalDataFull = [];
let attApprovalPage = 1;
const attApprovalPageSize = 10;

function loadAttendanceApprovals(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"getAttendance"})})
  .then(r=>r.json()).then(data=>{
    attApprovalDataFull = data.slice(1);
    attApprovalPage = 1;
    renderAttendanceApprovalTable();
  });
}

function renderAttendanceApprovalTable(){
  let start = (attApprovalPage-1)*attApprovalPageSize;
  let end = start + attApprovalPageSize;
  let pageData = attApprovalDataFull.slice(start,end);

  let html="<tr><th>Name</th><th>Date</th><th>Block</th><th>Status</th><th>Action</th></tr>";
  pageData.forEach((row,i)=>{
    if(userRole==="BPM" && row[7]==="Pending_BPM" && row[3]===userBlock)
      html+=`<tr><td>${row[1]}</td><td>${formatDate(row[0])}</td><td>${row[3]}</td><td>${row[7]}</td>
      <td><button onclick="approveAttendance(${i+1+(attApprovalPage-1)*attApprovalPageSize},'approveAttendanceBPM')">Approve</button></td></tr>`;
    if(userRole==="Block" && row[7]==="Pending_Block")
      html+=`<tr><td>${row[1]}</td><td>${formatDate(row[0])}</td><td>${row[3]}</td><td>${row[7]}</td>
      <td><button onclick="approveAttendance(${i+1+(attApprovalPage-1)*attApprovalPageSize},'approveAttendanceBlock')">Final Approve</button></td></tr>`;
  });

  html += `<tr><td colspan="5">
    <button onclick="changeAttendanceApprovalPage(-1)">Prev</button>
    Page ${attApprovalPage} of ${Math.ceil(attApprovalDataFull.length/attApprovalPageSize)}
    <button onclick="changeAttendanceApprovalPage(1)">Next</button>
  </td></tr>`;

  approvalAttendanceTable.innerHTML = html;
}

function changeAttendanceApprovalPage(delta){
  const totalPages = Math.ceil(attApprovalDataFull.length/attApprovalPageSize);
  attApprovalPage += delta;
  if(attApprovalPage<1) attApprovalPage=1;
  if(attApprovalPage>totalPages) attApprovalPage=totalPages;
  renderAttendanceApprovalTable();
}

function approveAttendance(row,action){
fetch(API,{method:"POST",body:JSON.stringify({action:action,row:row})})
.then(()=>{loadAttendanceApprovals(); loadReports();});
}

/* ---------- REPORTS WITH PAGINATION ---------- */
let reportDataFull = [];
let reportPage = 1;
const reportPageSize = 10;

function loadReports(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"getAttendance"})})
  .then(r=>r.json()).then(attData=>{
    fetch(API,{method:"POST",body:JSON.stringify({action:"getLeave"})})
    .then(r=>r.json()).then(leaveData=>{
      let attMap = {};
      attData.slice(1).forEach(r=>{
        if(userRole==="Cadre" && r[1]!==userName) return;
        if(userRole==="BPM" && r[3]!==userBlock) return;
        if(!attMap[r[1]]) attMap[r[1]]=0;
        attMap[r[1]]++;
      });
      reportDataFull = Object.entries(attMap).map(([name,count])=>({name,count}));
      reportPage = 1;
      renderReportTable(leaveData);
    });
  });
}

function renderReportTable(leaveData){
  let start = (reportPage-1)*reportPageSize;
  let end = start + reportPageSize;
  let pageData = reportDataFull.slice(start,end);

  let html="<h5>Attendance Summary</h5><table><tr><th>Name</th><th>Attendance Count</th></tr>";
  pageData.forEach(r=> html+=`<tr><td>${r.name}</td><td>${r.count}</td></tr>`);
  html += `<tr><td colspan="2">
    <button onclick="changeReportPage(-1)">Prev</button>
    Page ${reportPage} of ${Math.ceil(reportDataFull.length/reportPageSize)}
    <button onclick="changeReportPage(1)">Next</button>
  </td></tr>`;
  html+="</table>";

  html+="<h5>Leave Summary</h5><table><tr><th>Name</th><th>Days</th><th>Status</th></tr>";
  leaveData.slice(1).forEach(r=>{
    if(userRole==="Cadre" && r[1]!==userName) return;
    if(userRole==="BPM" && r[2]!==userBlock) return;
    html+=`<tr><td>${r[1]}</td><td>${r[5]}</td><td>${r[7]}</td></tr>`;
  });
  html+="</table>";

  reportContent.innerHTML=html;
}

function changeReportPage(delta){
  const totalPages = Math.ceil(reportDataFull.length/reportPageSize);
  reportPage += delta;
  if(reportPage<1) reportPage=1;
  if(reportPage>totalPages) reportPage=totalPages;
  renderReportTable([]);
}

/* ---------- COUNTS ---------- */
function loadCounts(){
fetch(API,{method:"POST",body:JSON.stringify({action:"getAttendance"})})
.then(r=>r.json()).then(data=>{attCount.innerText=data.length-1;});
fetch(API,{method:"POST",body:JSON.stringify({action:"getLeave"})})
.then(r=>r.json()).then(data=>{leaveCount.innerText=data.length-1;});
}

/* ---------- HELPERS ---------- */
function formatDate(dt){ return new Date(dt).toLocaleDateString(); }

</script>
</body>
</html>
